<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../image-gallery-popup/image-gallery-popup.html">
<link rel="import" href="../image-thumbnail-with-link/image-thumbnail-with-link.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<!--
A Polymer Element showing a gallery of image thumbnails that each open an image-gallery-popup when clicked or tapped.

### Example
```html
<image-gallery images="[[array]]"></image-gallery>
```

### Styling

`<image-gallery>` provides the following custom properties and mixins for styling:

Custom property          | Description                                  | Default
-------------------------|----------------------------------------------|--------
`--image-hovering-color` | The background color of the hovering images. | none
`--image-selected-color` | The background color of the selected images. | none

@demo demo/index.html
-->

<dom-module id="image-gallery">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>

    <style>
      :host {
        display: block;
      }

      image-thumbnail {
        height: 120px;
      }

      image-thumbnail ::content paper-button {
        margin: 5px;
        padding: 5px;
      }

      image-thumbnail.selected ::content .highlight,
      image-thumbnail-with-link.selected ::content .highlight {
        background-color: var(--image-selected-color);
      }

      image-thumbnail.hovering ::content .highlight,
      image-thumbnail-with-link.hovering ::content .highlight {
        background-color: var(--image-hovering-color);
      }
    </style>

    <div class="layout horizontal center-justified flex wrap" on-tap="_stopClickPropagation">
      <template is="dom-repeat" items="[[images]]" as="image">
        <template is="dom-if" if="[[_getProperty(image, imageLinkProperty)]]">
          <image-thumbnail-with-link
            id="[[_getProperty(image, imageIdProperty)]]"
            class$="[[_addStyleClass(selected, image, imageIdProperty, 'selected')]] [[_addStyleClass(hovering, image, imageIdProperty, 'hovering')]]"
            on-mouseover="_hoverStart"
            on-mouseout="_hoverEnd"
            highlight
            icon="[[_getIcon(newTab)]]"
            link="[[_getProperty(image, imageLinkProperty)]]"
            source="[[_getProperty(image, imageSourceProperty)]]"
            style-class="[[smallImageStyleClass]]"
            target="[[_getTarget(newTab)]]"
            text="Open"
            click-listener="[[_createImageClickListener()]]"
            click-title="[[_getImageTitle(index)]]"
            click-value="[[index]]">
          </image-thumbnail-with-link>
        </template>

        <template is="dom-if" if="[[!_getProperty(image, imageLinkProperty)]]">
          <image-thumbnail
            id="[[_getProperty(image, imageIdProperty)]]"
            class$="[[_addStyleClass(selected, image, imageIdProperty, 'selected')]] [[_addStyleClass(hovering, image, imageIdProperty, 'hovering')]]"
            on-mouseover="_hoverStart"
            on-mouseout="_hoverEnd"
            highlight
            source="[[_getProperty(image, imageSourceProperty)]]"
            style-class="[[smallImageStyleClass]]"
            click-listener="[[_createImageClickListener()]]"
            click-title="[[_getImageTitle(index)]]"
            click-value="[[index]]">
          </image-thumbnail-with-link>
        </template>
      </template>
    </div>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'image-gallery',

      properties: {
        /**
         * (Required)
         *
         * The list of image objects.
         *
         * @type {Array}
         * @default []
         */
        images: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * (Optional)
         *
         * The unique ID property in the image objects.
         *
         * @type {String}
         * @default 'id'
         */
        imageIdProperty: {
          type: String,
          value: 'id'
        },

        /**
         * (Optional)
         *
         * The link URL property in the image objects to open information within the application.
         *
         * @type {String}
         * @default 'link'
         */
        imageLinkProperty: {
          type: String,
          value: 'link'
        },

        /**
         * (Optional)
         *
         * The source URL property in the image objects.
         *
         * @type {String}
         * @default 'source'
         */
        imageSourceProperty: {
          type: String,
          value: 'source'
        },

        /**
         * (Optional)
         *
         * The style class for all the images in the gallery.
         *
         * @type {String}
         * @default ''
         */
        smallImageStyleClass: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The style class for any image in a popup.
         *
         * @type {String}
         * @default ''
         */
        largeImageStyleClass: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The list of image IDs targeted by a hover event.
         *
         * @type {Array}
         * @default []
         */
        hovering: {
          notify: true,
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * (Optional)
         *
         * Whether to open a link in a new tab.
         *
         * @type {Boolean}
         * @default false
         */
        newTab: {
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The list of selected image IDs.
         *
         * @type {Array}
         * @default []
         */
        selected: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },

      /**
       * Returns whether the value in the given item at the given property is in the given list.
       *
       * @param {Array} list
       * @param {Object} item
       * @param {String} property
       * @return {Boolean}
       * @private
       */
      _addStyleClass: function(list, item, property, styleClass) {
        return item && typeof item[property] !== 'undefined' && list.indexOf(item[property]) >= 0 ? styleClass : '';
      },

      /**
       * Returns the icon for links.
       *
       * @param {Boolean} newTab
       * @return {String}
       * @private
       */
      _getIcon: function(newTab) {
        return (newTab ? 'open-in-new' : 'open-in-browser');
      },

      /**
       * Returns the title for the image at the given index.
       *
       * @param {Number} index
       * @return {String}
       * @private
       */
      _getImageTitle: function(index) {
        return 'Click to View Full-Size Image #' + (index + 1);
      },

      /**
       * Returns the given property in the given item or the given default value if the property is empty.
       *
       * @param {Object} item
       * @param {String} property
       * @param defaultValue
       * @return
       * @private
       */
      _getProperty: function(item, property, defaultValue) {
        return item[property] || defaultValue;
      },

      /**
       * Returns the target for links.
       *
       * @param {Boolean} newTab
       * @return {String}
       * @private
       */
      _getTarget: function(newTab) {
        return (newTab ? '_blank' : '_self');
      },

      /**
       * Resets the hovering array.
       *
       * @event mouseout
       * @private
       */
      _hoverEnd: function() {
        this.set('hovering', []);
      },

      /**
       * Sets the hovering array to the ID of the image in the given event model.
       *
       * @event mouseover
       * @private
       */
      _hoverStart: function(event) {
        this.set('hovering', [event.model.image[this.imageIdProperty]]);
      },

      /**
       * Stops propagation of the given click event on the container element.
       *
       * @event tap
       * @private
       */
      _stopClickPropagation: function(event) {
        event.stopImmediatePropagation();
      },

      /**
       * Creates and returns a click listener for the image thumbnails that opens the image in an image-gallery-popup.
       *
       * @return {Object}
       * @private
       */
      _createImageClickListener: function() {
        var self = this;

        var createPopupElement = function(index) {
          /* Appending image-gallery-popup element with paper-dialog to body when
             opened -- workaround for unexpected behavior with overlays, which should
             be placed directly in the body tag whenever possible:
             https://github.com/PolymerElements/polymer-starter-kit/issues/154
             https://github.com/PolymerElements/paper-dialog/issues/79#issuecomment-201681529
          */
          var body = Polymer.dom(document).querySelector('body');
          var firstChildOfBody = Polymer.dom(body).firstChild;
          var imageGalleryPopupElement = document.createElement('image-gallery-popup');

          imageGalleryPopupElement.images = self.images;
          imageGalleryPopupElement.imageLinkProperty = self.imageLinkProperty;
          imageGalleryPopupElement.imageSourceProperty = self.imageSourceProperty;
          imageGalleryPopupElement.currentIndex = index;
          imageGalleryPopupElement.linkText = 'open image';
          imageGalleryPopupElement.linkTarget = self._getTarget(self.newTab);
          imageGalleryPopupElement.styleClass = self.largeImageStyleClass;

          body.insertBefore(imageGalleryPopupElement, firstChildOfBody);
        };

        return {
          onClick: createPopupElement
        };
      }
    });
  })();
  </script>
</dom-module>
